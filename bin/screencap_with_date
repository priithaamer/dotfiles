#!/usr/bin/env bash

function screenIsLocked { [ "$(/usr/libexec/PlistBuddy -c "print :IOConsoleUsers:0:CGSSessionScreenIsLocked" /dev/stdin 2>/dev/null <<< "$(ioreg -n Root -d1 -a)")" = "true" ] && return 0 || return 1; }
function screenIsUnlocked { [ "$(/usr/libexec/PlistBuddy -c "print :IOConsoleUsers:0:CGSSessionScreenIsLocked" /dev/stdin 2>/dev/null <<< "$(ioreg -n Root -d1 -a)")" != "true" ] && return 0 || return 1; }

if screenIsLocked; then
    echo "Screen locked"
else
  yeer=`date +'%Y'`
  datestr=`date +'%Y%m%d%H%M%S'`
  target_directory="/Users/priit/Documents/Screenshots/$yeer"
  jpg_filename="/tmp/$datestr.jpg"
  jxl_filename="$target_directory/$datestr.jxl"

  mkdir -p $target_directory

  /usr/sbin/screencapture -C -t jpg -x $jpg_filename
  /opt/homebrew/bin/cjxl $jpg_filename $jxl_filename --quality=75 --lossless_jpeg=0
  rm $jpg_filename
fi
